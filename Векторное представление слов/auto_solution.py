import gensim
import sys
import os
import re

def load_model():
    model_path = os.path.join(os.path.dirname(__file__), "cbow.txt")
    model = gensim.models.KeyedVectors.load_word2vec_format(model_path, binary=False)
    print("Model loaded.")
    return model



"""
Перебирать все слова и их линейные комбинации очень долго и вычислительно сложно, поэтому воспользуемся некоторой эвристикой. 
За значение целевого вектора возьмем сумму векторов данных слов. V_target \approx V_word1 + V_word2. Это очень грубое упрощение, но практика показала что допустимое.
Теперь надо найти такую пару (X,Y), чтобы V_target \approx X + Y. Опыты показали что найти такие векторы с вычитанием намногосложенее. 
Теперь мы будем перебирать самые "используемые слова", фиксировать их как Y и подбирать такой X, чтобы V_target \approx X + Y, то есть X \approx Y - V_target. Так мы получим вектор примерного X и перебираем топ 20 ближайших к нему слов как кандидатов на второе слово.
"""

def get_nouns(model, limit=500):
    nouns = []
    pat = re.compile("(.*)_NOUN")
    for key in model.index_to_key:
        if pat.match(key):
            nouns.append(key)
        if len(nouns) >= limit:
            break
    return nouns, pat

def clean_word(word):
    return word.split('_')[0]

def solve_auto(w1, w2):
    model = load_model()
    if not model: return

    if not w1.endswith("_NOUN"): w1 += "_NOUN"
    if not w2.endswith("_NOUN"): w2 += "_NOUN"

    if w1 not in model or w2 not in model:
        print(f"Ошибка: Одно из слов '{w1}', '{w2}' отсутствует в словаре.")
        return

    print(f"Целевые слова: {w1}, {w2}")
    

    centroid_vec = model[w1] + model[w2]
    
    nouns, pat = get_nouns(model, limit=2000)
    
    best_solution = None
    min_rank_sum = 100 
    
    
    print("\n--- Проверка сумм (X + Y) ---")
    for i, y in enumerate(nouns):
        if y == w1 or y == w2: continue
        
        # Оценка X
        target_x = centroid_vec - model[y]
        
        # Проверяем ближайших соседей для X (увеличиваем кандидатов для лучшего совпадения)
        candidates_x = model.most_similar(positive=[target_x], topn=20)
        
        for item in candidates_x:
            x = item[0]
            if not pat.match(x): continue
            if x == y or x == w1 or x == w2: continue
            
            # Проверяем пару
            res_vec = model[x] + model[y]
            sims = model.most_similar(positive=[res_vec], topn=10)
            found = [s[0] for s in sims]
            
            if w1 in found and w2 in found:
                rank1 = found.index(w1)
                rank2 = found.index(w2)
                rank_sum = rank1 + rank2
                
                print(f"\n Найден кандидат: {clean_word(x)} + {clean_word(y)} (Ранги: {rank1}, {rank2})")

                
                if rank_sum < min_rank_sum:
                    min_rank_sum = rank_sum
                    best_solution = {
                        'type': 'Sum',
                        'x': x, 'y': y,
                        'sims': sims
                    }

    
    if best_solution:
        print(f"\nЛУЧШЕЕ РЕШЕНИЕ ИЗ НАЙДЕННЫХ")
        x = clean_word(best_solution['x'])
        y = clean_word(best_solution['y'])
        op = "+" if best_solution['type'] == 'Sum' else "-"
        print(f"Пара: {x}, {y}")
        print(f"Операция: {x} {op} {y}")
        print("Топ-10 ближайших соседей результата:")
        for s in best_solution['sims']:
            word_clean = clean_word(s[0])
            mark = " <--- ЦЕЛЬ" if s[0] in [w1, w2] else ""
            print(f"  {word_clean:<20} ({s[1]:.4f}){mark}")
    else:
        print("\nПодходящая пара не найдена в области поиска.")

if __name__ == "__main__":
    if len(sys.argv) == 3:
        w1 = sys.argv[1]
        w2 = sys.argv[2]
    
    solve_auto(w1, w2)


"""
Примеры:

%python "auto_solution.py" "бумага" "металл"
Model loaded.
Целевые слова: бумага_NOUN, металл_NOUN

--- Проверка сумм (X + Y) ---

 Найден кандидат: медь + документ (Ранги: 5, 7)

 Найден кандидат: сплав + бумажка (Ранги: 2, 8)

 Найден кандидат: сплав + листок (Ранги: 4, 8)

 Найден кандидат: медь + протокол (Ранги: 4, 3)

 Найден кандидат: сталь + протокол (Ранги: 7, 8)

 Найден кандидат: железо + протокол (Ранги: 3, 6)

ЛУЧШЕЕ РЕШЕНИЕ ИЗ НАЙДЕННЫХ
Пара: медь, протокол
Операция: медь + протокол
Топ-10 ближайших соседей результата:
  протокол             (0.7688)
  медь                 (0.5995)
  документ             (0.4783)
  металл               (0.4672) <--- ЦЕЛЬ
  бумага               (0.4566) <--- ЦЕЛЬ
  олово                (0.4447)
  ниобие               (0.4334)
  документация         (0.4316)
  цинк                 (0.4260)

  
-------------------------------

%python "auto_solution.py" "пергамент" "полиэтилен"
Model loaded.
Целевые слова: пергамент_NOUN, полиэтилен_NOUN
Фильтрация топ 2000 существительных...
Поиск пары (X, Y), такой что X, Y != целевым словам и (X +/- Y) помещает целевые слова в Топ-10...

--- Проверка сумм (X + Y) ---

 Найден кандидат: нейлон + бумага (Ранги: 4, 6)

 Найден кандидат: битум + бумага (Ранги: 3, 6)

 Найден кандидат: ткань + бумага (Ранги: 4, 5)

 Найден кандидат: бумага + слой (Ранги: 8, 9)

 Найден кандидат: бумага + металл (Ранги: 5, 3)

 Найден кандидат: бумага + ткань (Ранги: 4, 5)

 Найден кандидат: конторка + ткань (Ранги: 6, 7)

 Найден кандидат: рулон + веко (Ранги: 8, 6)

 Найден кандидат: картон + остатки (Ранги: 9, 4)

 Найден кандидат: фольга + свидетельство (Ранги: 2, 7)

 Найден кандидат: вата + свидетельство (Ранги: 4, 9)

 Найден кандидат: воск + пакет (Ранги: 7, 9)

 Найден кандидат: свиток + пленка (Ранги: 4, 6)

ЛУЧШЕЕ РЕШЕНИЕ ИЗ НАЙДЕННЫХ
Пара: бумага, металл
Операция: бумага + металл
Топ-10 ближайших соседей результата:
  бумага               (0.7767)
  металл               (0.7631)
  картон               (0.5793)
  полиэтилен           (0.5645) <--- ЦЕЛЬ
  латунь               (0.5566)
  пергамент            (0.5561) <--- ЦЕЛЬ
  пергамен             (0.5559)
  бумага               (0.5531)
  олово                (0.5519)
  графит               (0.5503)

  
---------------------------------

%python "auto_solution.py" "облако" "машина"
Model loaded.
Целевые слова: облако_NOUN, машина_NOUN

--- Проверка сумм (X + Y) ---

 Найден кандидат: лимузин + воздух (Ранги: 8, 4)

 Найден кандидат: автомобиль + небо (Ранги: 2, 6)

 Найден кандидат: туча + автомобиль (Ранги: 1, 4)

 Найден кандидат: облачко + автомобиль (Ранги: 4, 3)

 Найден кандидат: небо + автомобиль (Ранги: 2, 6)

 Найден кандидат: туман + автомобиль (Ранги: 3, 5)

 Найден кандидат: горизонт + автомобиль (Ранги: 9, 2)

 Найден кандидат: автомобиль + туман (Ранги: 3, 5)

 Найден кандидат: автомобиль + горизонт (Ранги: 9, 2)

 Найден кандидат: автомашина + горизонт (Ранги: 5, 4)

 Найден кандидат: автомобиль + туча (Ранги: 1, 4)

ЛУЧШЕЕ РЕШЕНИЕ ИЗ НАЙДЕННЫХ
Пара: туча, автомобиль
Операция: туча + автомобиль
Топ-10 ближайших соседей результата:
  туча                 (0.7632)
  облако               (0.6687) <--- ЦЕЛЬ
  автомобиль           (0.6643)
  грузовик             (0.5801)
  машина               (0.5714) <--- ЦЕЛЬ
  машина               (0.5609)
  джип                 (0.5541)
  авто                 (0.5475)
  туман                (0.5387)
  мгла                 (0.5263)

"""